# ai_sql_map_local2602

폐쇄망에서도 동작되는 Local LLM과 DuckDB를 활용한 온디바이스 공간 분석 지도 서비스  

# On-Device Geo AI 

본 프로젝트는 데이터 보안과 비용 효율성을 극대화하기 위해 로컬 LLM(Qwen 2.5)과  공간 데이터베이스(DuckDB)를 결합한 온디바이스 GIS 분석 환경을 개념 증명(PoC)  

---

## 🚀 주요 기능 (Key Features)

* **자연어 기반 공간 질의**: "서울역 근처 소방서 찾아줘"와 같은 일상 언어로 지도 분석 가능 
* **온디바이스 LLM**: 모든 연산이 사용자 PC 내부에서 이루어져 외부 서버 유출 우려 없음 
* **DB없이 대규모 데이터 처리**: GeoParquet 형식을 활용하여 대용량 공간 정보 고속 조회 

---

## 🏗️ 시스템 아키텍처 (Architecture)

데이터 처리 효율성과 로컬 추론의 안정성을 위해 다음과 같은 기술 스택을 적용했습니다. 

| 구성 요소 | 기술 스택 | 주요 역할 |
| :--- | :--- | :--- |
| **Inference Engine** | **Ollama** | 로컬 환경 내 LLM 실행 및 관리 인프라 |
| **LLM** | **Qwen 2.5 (7B)** | 자연어 질의 분석 및 정형 데이터(JSON) 추출 |
| **Spatial DB** | **DuckDB (Spatial Ext.)** | In-process OLAP 엔진을 활용한 고속 공간 쿼리 수행 |
| **Data Format** | **GeoParquet** | 공간 정보에 최적화된 컬럼 지향 저장 형식 활용 |
| **Backend** | **FastAPI** | 비동기 API 통신 및 LLM/DB 로직 통합 |
| **Frontend** | **MapLibre GL JS** | WebGL 기반의 고성능 대화형 지도 렌더링 |

---

## 📊 성능 테스트 결과 (Performance)

"롯데마트 서울역점에서 가장 가까운 소방서" 쿼리를 기준으로 3가지 모델의 성능을 비교 분석하였습니다. 

| 순위 | 모델 | 평균 응답 시간 | 최소/최대 | 성공률 |
| :--- | :--- | :--- | :--- | :--- |
| **🥇 1** | **로컬 Ollama (qwen2.5:7b)** | **0.550초** | 0.289s / 2.835s | 100% |
| 🥈 2 | 내부 서버 (gpt-oss-20b) | 1.656초 | 1.643s / 1.690s | 100% |
| 🥉 3 | 로컬 Ollama (gpt-oss:20b) | 6.179초 | 5.531s / 9.060s | 100% |

> **Insight:** 로컬에서 구동되는 **Qwen 2.5 (7B)** 모델이 서버 모델 대비 약 **3배 빠른 속도**를 보여주며, 온디바이스 GIS 환경에 가장 적합한 모델임을 확인했습니다. 

---

## 🛠️ 핵심 분석 파이프라인 (Workflow)

사용자의 자연어 질의가 시각적 결과물로 변환되는 4단계 과정입니다. 

1.  **의도 파악 (Extract)**: LLM이 질의에서 마트 이름 등 핵심 키워드를 JSON으로 추출합니다. 
2.  **공간 연산 (Calculate)**: DuckDB의 `ST_Distance` 함수로 최단 거리 시설물을 계산합니다. 
3.  **좌표 변환 (Convert)**: `pyproj`를 통해 EPSG:5179 좌표를 글로벌 웹 표준인 EPSG:4326으로 변환합니다.  
4.  **시각화 (Render)**: 분석 결과를 GeoJSON으로 변환하여 MapLibre GL JS 지도 위에 렌더링합니다. 

---

## 🔒 데이터 보안 (Security)

이 시스템은 폐쇄망 환경에서도 작동하도록 설계되었습니다.   
모든 연산이 사용자 PC 내부에서 완결되므로, 민감한 시설물 위치나 비즈니스 쿼리가 외부 서버로 유출될 가능성은 0%입니다.   

---

## 📅 향후 과제 (Future Roadmap)

* 유클리드 기반 근린분석 외에 다양한 공간 분석 기능 추가 필요  
* 지도 제어  
 
